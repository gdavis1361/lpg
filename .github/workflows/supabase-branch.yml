name: Supabase Branch Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'lpg-backend/supabase/**'
      - '.github/workflows/supabase-branch.yml'

# Add explicit permissions
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  create-branch-environment:
    runs-on: ubuntu-latest
    
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: Install backend dependencies
        working-directory: lpg-backend
        run: |
          npm ci --legacy-peer-deps
          echo "Node $(node -v)"
          echo "NPM $(npm -v)"

      # Install Supabase CLI using official action
      - uses: supabase/setup-cli@v1
        with:
          version: 2.22.6
          
      - name: Verify Supabase CLI
        run: |
          echo "Supabase CLI $(supabase --version)"
            
      # Install and configure Doppler CLI for secure environment variable access
      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v2
      
      - name: Setup Doppler
        run: |
          doppler setup --no-interactive --token=${{ secrets.DOPPLER_TOKEN }} --project=lpg --config=dev
      
      # This step is no longer needed since we use PR number directly
      # But keeping a simplified version for backwards compatibility
      - name: Extract branch name
        id: extract_branch
        run: |
          echo "branch_name=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
      
      # Create or update Supabase branch environment
      - name: Create/Update Supabase branch environment
        id: supabase_branch
        working-directory: lpg-backend
        run: |
          # Get Supabase project ID from Doppler
          PROJECT_ID=$(doppler run --project lpg --config dev -- echo $SUPABASE_PROJECT_ID)
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          
          # Debug info for troubleshooting
          echo "Supabase project ID: $PROJECT_ID"
          echo "Supabase CLI version: $(supabase --version)"
          
          # First link the project (required before branch operations)
          echo "Linking to Supabase project $PROJECT_ID"
          supabase link --project-ref $PROJECT_ID
          
          # Create a PR-specific branch name with prefix for clarity
          BRANCH_NAME="pr-${{ github.event.number }}"
          echo "PR-specific branch name: $BRANCH_NAME"
          
          # Check if branch already exists
          BRANCH_EXISTS=$(supabase branches list --output=json --experimental | jq --arg branch "$BRANCH_NAME" '.[] | select(.name==$branch) | .id' -r || echo "")
          
          if [ -z "$BRANCH_EXISTS" ]; then
            echo "Creating new Supabase branch: $BRANCH_NAME"
            BRANCH_ID=$(supabase branches create "$BRANCH_NAME" --output=json --experimental | jq '.id' -r)
            echo "branch_id=$BRANCH_ID" >> $GITHUB_OUTPUT
            echo "created=true" >> $GITHUB_OUTPUT
          else
            echo "Using existing Supabase branch: $BRANCH_NAME"
            echo "branch_id=$BRANCH_EXISTS" >> $GITHUB_OUTPUT
            echo "created=false" >> $GITHUB_OUTPUT
          fi
      
      # Apply migrations to branch environment
      - name: Apply migrations to branch
        working-directory: lpg-backend
        run: |
          # Get current branch ID
          BRANCH_ID=${{ steps.supabase_branch.outputs.branch_id }}
          
          # Get Supabase project ID 
          PROJECT_ID=${{ steps.supabase_branch.outputs.project_id }}
          
          # Apply migrations to the branch
          echo "Applying migrations to branch: pr-${{ github.event.number }}"
          supabase db push --experimental
      
      # Run migration validation
      - name: Validate migrations
        working-directory: lpg-backend
        run: |
          # Run validation script using Doppler for env vars
          doppler run --project lpg --config dev -- node scripts/validate-migrations.js --branch=${{ steps.supabase_branch.outputs.branch_id }} || echo "Validation script not fully implemented yet"
        continue-on-error: true  # Allow this to fail until script is implemented
      
      # Add comment to PR with branch details
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = 'pr-${{ github.event.number }}';
            const branchId = '${{ steps.supabase_branch.outputs.branch_id }}';
            const projectId = '${{ steps.supabase_branch.outputs.project_id }}';
            const wasCreated = '${{ steps.supabase_branch.outputs.created }}' === 'true';
            
            const comment = `## Supabase Branch Environment
            
            ${wasCreated ? 'üÜï Created new' : 'üîÑ Using existing'} Supabase branch environment: **${branchName}**
            
            ### Branch Details
            - **Branch ID:** \`${branchId}\`
            - **Status:** Migration${wasCreated ? 's applied' : ' update attempted'}
            
            To connect to this branch environment locally:
            \`\`\`bash
            cd lpg-backend
            supabase link --project-ref=${projectId} --branch=${branchId}
            \`\`\`
            
            To run migrations against this branch:
            \`\`\`bash
            cd lpg-backend
            supabase db push --experimental
            \`\`\`
            
            ‚ÑπÔ∏è You can view this branch in the Supabase Dashboard under **Project Settings ‚Üí Branch Environments**
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # Notify on failure
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## ‚ùå Supabase Branch Environment Setup Failed
            
            The workflow to create or update a Supabase branch environment for this PR failed.
            
            Please check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
